name: Release workflow

on:
  push:
    tags:
      - "[0-9]{3}.[0-9]+.[0-9]+(?:b[0-9]+)?"

premissions: {}

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4.2.2

      - name: Validate data
        id: integration
        run: |
          manifestversion=$(jq -r '.version' ./custom_components/healthchecksio/manifest.json)
          if [ "$manifestversion" != "${{ github.ref_name }}" ]; then
            echo "The version in custom_components/healthchecksio/manifest.json was not correct"
            echo "$manifestversion"
            exit 1
          fi
          echo "version=$manifestversion" >> $GITHUB_OUTPUT

      - name: Create zip file for the integration
        run: |
          cd "./custom_components/healthchecksio"
          zip healthchecksio.zip -r ./

      - name: Upload the zip file
        uses: actions/upload-artifact@v4.5.0
        with:
          name: healthchecksio.zip

      - name: Create summary
        run: |
            echo "### Release Preparation Summary" >> $GITHUB_STEP_SUMMARY
            echo "- The integration has been prepared for release" >> $GITHUB_STEP_SUMMARY
            echo "- Manifest version: ${{ steps.integration.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- Tag name: ${{ github.tag_name }}" >> $GITHUB_STEP_SUMMARY

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: prepare
    environment:
      name: publish
      url: ${{ steps.release.outputs.url }}
    premissions:
      contents: write
    steps:
      - name: Download the zip file
        uses: actions/download-artifact@v4.1.8
        with:
          name: healthchecksio.zip

      - name: Release
        uses: softprops/action-gh-release@v2.2.0
        id: release
        with:
          generate_release_notes: true
          fail_on_unmatched_files: true
          prerelease: contains(github.ref, '.0b')
          files: |
            healthchecksio.zip
